# 多进程`fork`支持

[TOC]

# 1. 当前存在的问题

使用Polaris C++接入北极星时，同种类型的API对象一个进程只需创建一个即可，API对象上的接口是线程安全的。
API对象内部会创建内部线程用于执行服务缓存数据同步、故障熔断恢复。
并且创建API对象时会触发创建`time_ticker`线程用于更新全局时间变量。

所以默认情况下SDK是不支持`fork()`调用的。`fork`后子进程中的API对象内部线程全部丢失，无法再继续使用。

# 2. 解决方法

可以通过如下两种方法在需要fork子进程时正确使用SDK

## 2.1 避免在`fork`之前创建API对象

避免在`fork`之前创建北极星API对象，等所有进程都启动完成后，在每个进程中去创建北极星API对象即可。
这种情况下，不需要北极星SDK支持fork。

## 2.2 在`fork`之前必须使用API对象

如果必须在`fork`之前使用API对象，那么在子进程中无法再使用父进程中创建的API对象，也无法释放该对象，
只能选择泄露该API对象内存。

**注意**：在子进程调用API对象进行服务发现时，可能不会报错，这是由于之前在父进程中已经拉取了该服务的数据，
但其实该SDK对象不会再更新数据，且SDK内部线程和锁已经不正常。

为了避免业务误用，所以如果已创建API对象，默认不支持`fork`。
业务需要通过如下两种编译方式让SDK支持在`fork`前创建SDK，并且业务需要自己保证在子进程中重新创建API使用。

### 2.2.1 编译参数1（推荐）
编译时，添加支持`fork`的参数。子进程中重新创建API对象使用，之前的API对象不用释放。
```bash
make SupportFork=true
```

### 2.2.2 编译参数2（不推荐）
编译时，添加屏蔽`time_ticker`线程的参数。屏蔽后，所有时间获取均走系统调用，可能影响性能。
```bash
make DisableTimeTicker=true
```
