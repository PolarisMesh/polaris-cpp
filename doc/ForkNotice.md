# 多进程`fork`时使用北极星的注意事项

[TOC]

## 1. 存在的问题

Polaris C++ SDK是内部使用了多线程异步执行服务缓存数据同步、故障熔断等逻辑。
所以在业务使用多进程模型需要注意：**不能在子进程中使用父进程创建的北极星API对象**

这是因为linux的`fork`机制会导致`fork`后子进程中的API对象内部线程全部丢失，且锁的可能会处于不正常状态。
如果在子进程中继续使用父进程创建的API对象，可能会导致死锁，且SDK内部数据没有线程任务去更新。

## 2. 如何规避

规避上述问题有两种方法，二选一即可。

### 2.1 方法1：避免在`fork`之前创建API对象

避免在`fork`之前创建北极星API对象，等所有进程都启动完成后，在每个进程中去创建北极星API对象即可。
这种情况下，不需要北极星SDK支持fork。

### 2.2 方法2：子进程避免访问父进程创建的API对象

如果必须在`fork`之前使用API对象，那么业务在子进程中重新创建新的API对象使用即可，父进程创建的API对象无法使用，同时也无法释放，不用管。
如果在fork时发生`coredump`，请更新到3.1小结中的版本，如果不方便更新版本请使用3.2中的方法处理


## 3. 使用不同版本SDK的关于`fork`的注意事项

### 3.1 使用v0.9.5及以上、v0.10.3及以上、v0.11.x及以上版本

如果业务在子进程中调用父进程中创建的api对象接口会报错1050

### 3.2 使用v0.6.1到v0.9.4、v0.10.0到v0.10.2

从v0.6.1版本开始为了避免业务误用，在业务已创建API对象，进行`fork`时会core掉进程以期望提醒业务使用方法错误
大多数使用多进程的业务能够在开发阶段发现用法问题并规避。

不建议使用：业务需要在编译时通过编译参数让SDK支持`fork`，并且业务需要自己保证在子进程中重新创建API使用。
方法如下：
```bash
make SupportFork=true
```
**注意**：未添加该参数，如果在fork前创建了api对象会引起core。多线程业务如果不清楚自己是否使用fork，请更新到3.1中的版本

### 3.3 使用v0.6.1之前的版本

这些可能不会报错，这是由于之前在父进程中已经拉取了该服务的数据，
但其实该SDK对象不会再更新数据，且SDK内部线程和锁已经不正常。请使用第2节中的方法规避。
